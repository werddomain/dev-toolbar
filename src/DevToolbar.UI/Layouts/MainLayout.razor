@using DevToolbar.Core.Interfaces
@using DevToolbar.Core.Models
@using DevToolbar.UI.Services
@using DevToolbar.UI.Components
@implements IDisposable
@inject IPluginLoader PluginLoader
@inject ISettingsService SettingsService
@inject IProcessService ProcessService
@inject INotificationService NotificationService
@inject IScriptService ScriptService
@inject ThemeService ThemeService

<div class="toolbar-shell" style="@ThemeService.GetCssVariables()">
    @* ‚îÄ‚îÄ Left: Project module (z-index: 20) ‚îÄ‚îÄ *@
    <div class="module-project">
        <header class="toolbar-header">
            <div class="toolbar-brand">
                <span class="brand-icon">üõ†</span>
                <span class="brand-title">DevToolbar</span>
            </div>
            <div class="toolbar-header-controls">
                <ProjectSelector />
            </div>
        </header>
    </div>

    @* ‚îÄ‚îÄ Middle: Git module overlapping under Project (z-index: 10) ‚îÄ‚îÄ *@
    <div class="module-git">
        @{
            var gitPlugin = _visiblePlugins?.FirstOrDefault(p => p.UniqueId == "git-tools");
        }
        @if (gitPlugin?.IsEnabled == true && gitPlugin.Render() is { } gitFragment)
        {
            <div class="plugin-panel" data-plugin-id="@gitPlugin.UniqueId" aria-label="@gitPlugin.Name">
                <h4 class="plugin-title">@gitPlugin.Name</h4>
                <div class="plugin-content">@gitFragment</div>
            </div>
        }
    </div>

    @* ‚îÄ‚îÄ Center: Plugin zone + Actions (z-index: 1) ‚îÄ‚îÄ *@
    <main class="toolbar-main">
        <section class="toolbar-plugins">
            <PluginZone Plugins="@_pluginZonePlugins" />
        </section>

        <section class="toolbar-actions">
            <ActionDeck Actions="@_actions" OnActionClicked="HandleActionClicked" />
        </section>
    </main>

    @* ‚îÄ‚îÄ Right: System zone (z-index: 20) ‚îÄ‚îÄ *@
    <div class="module-system">
        <button class="toolbar-report-btn" @onclick="ToggleTimeReport" title="Time Report (Ctrl+R)">üìä</button>
        <a href="/settings" class="toolbar-settings-btn" title="Settings (Ctrl+,)">‚öôÔ∏è</a>
    </div>
</div>

@* ‚îÄ‚îÄ Footer status bar below the pill ‚îÄ‚îÄ *@
<footer class="toolbar-footer">
    <span class="footer-project">@_activeProjectName</span>
    <span class="footer-separator">|</span>
    <span class="footer-plugin-count">@_pluginCount plugins</span>
    <span class="footer-separator">|</span>
    <span class="footer-shortcuts">Esc to close modals</span>
</footer>

@* ‚îÄ‚îÄ Overlays ‚îÄ‚îÄ *@
<TimeReport IsVisible="@_showTimeReport" OnClose="CloseTimeReport" />
<TerminalOutput @ref="_terminalOutput" IsVisible="@_showTerminal" OnClose="CloseTerminal" />
<ToastContainer />

@code {
    private List<ActionConfig> _actions = new();
    private IReadOnlyList<IPlugin>? _visiblePlugins;
    private IReadOnlyList<IPlugin>? _pluginZonePlugins;
    private bool _showTimeReport;
    private bool _showTerminal;
    private TerminalOutput? _terminalOutput;
    private string _activeProjectName = "";
    private int _pluginCount;

    protected override async Task OnInitializedAsync()
    {
        SettingsService.OnActiveProjectChanged += OnProjectChanged;

        var project = SettingsService.GetActiveProject();
        if (project != null)
        {
            await ApplyProjectAsync(project);
        }
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            ThemeService.OnThemeChanged += OnThemeChanged;
        }
    }

    private void OnThemeChanged()
    {
        _ = InvokeAsync(StateHasChanged);
    }

    private async Task ApplyProjectAsync(ProjectConfig project)
    {
        _actions = project.Actions;
        _activeProjectName = project.Name;
        ThemeService.SetTheme(project.Theme);

        var allPlugins = PluginLoader.GetPlugins();
        _visiblePlugins = allPlugins
            .Where(p => project.EnabledPlugins.Contains(p.UniqueId))
            .ToList()
            .AsReadOnly();

        _pluginZonePlugins = _visiblePlugins
            .Where(p => p.UniqueId != "git-tools")
            .ToList()
            .AsReadOnly();

        _pluginCount = _visiblePlugins.Count;

        var context = new PluginContext { Project = project };
        var tasks = allPlugins.Select(p => p.OnProjectChangedAsync(context));
        await Task.WhenAll(tasks);
    }

    private void OnProjectChanged(ProjectConfig project)
    {
        InvokeAsync(async () =>
        {
            await ApplyProjectAsync(project);
            StateHasChanged();
        });
    }

    private void ToggleTimeReport()
    {
        _showTimeReport = !_showTimeReport;
    }

    private void CloseTimeReport()
    {
        _showTimeReport = false;
    }

    private void CloseTerminal()
    {
        _showTerminal = false;
    }

    private async Task HandleActionClicked(ActionConfig action)
    {
        try
        {
            if (action.ActionType == ActionType.Script)
            {
                _showTerminal = true;
                StateHasChanged();
                await Task.Yield();
                if (_terminalOutput != null)
                {
                    await _terminalOutput.RunScript(ScriptService, action.Interpreter ?? "pwsh", action.ProcessPath, action.Arguments);
                }
                return;
            }

            if (!string.IsNullOrEmpty(action.WindowTitleRegex))
            {
                if (!ProcessService.FocusWindowByTitle(action.WindowTitleRegex))
                {
                    await ProcessService.StartProcessAsync(action.ProcessPath, action.Arguments);
                }
            }
            else
            {
                await ProcessService.StartProcessAsync(action.ProcessPath, action.Arguments);
            }
            NotificationService.ShowSuccess($"Launched {action.Label}", "Action");
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to launch {action.Label}: {ex.Message}", "Error");
        }
    }

    public void Dispose()
    {
        SettingsService.OnActiveProjectChanged -= OnProjectChanged;
        ThemeService.OnThemeChanged -= OnThemeChanged;
    }
}
