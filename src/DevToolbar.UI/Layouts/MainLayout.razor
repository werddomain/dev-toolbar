@using DevToolbar.Core.Interfaces
@using DevToolbar.Core.Models
@using DevToolbar.UI.Services
@using DevToolbar.UI.Components
@implements IDisposable
@inject IPluginLoader PluginLoader
@inject ISettingsService SettingsService
@inject IProcessService ProcessService
@inject INotificationService NotificationService
@inject IScriptService ScriptService
@inject ThemeService ThemeService

<div class="toolbar-shell" style="@ThemeService.GetCssVariables()">
    <header class="toolbar-header">
        <div class="toolbar-brand">
            <span class="brand-icon">üõ†</span>
            <span class="brand-title">DevToolbar</span>
        </div>
        <div class="toolbar-header-controls">
            <ProjectSelector />
            <button class="toolbar-report-btn" @onclick="ToggleTimeReport" title="Time Report">üìä</button>
            <a href="/settings" class="toolbar-settings-btn" title="Settings">‚öôÔ∏è</a>
        </div>
    </header>

    <main class="toolbar-main">
        <section class="toolbar-plugins">
            <PluginZone Plugins="@_visiblePlugins" />
        </section>

        <section class="toolbar-actions">
            <ActionDeck Actions="@_actions" OnActionClicked="HandleActionClicked" />
        </section>
    </main>

    <TimeReport IsVisible="@_showTimeReport" OnClose="CloseTimeReport" />
    <TerminalOutput @ref="_terminalOutput" IsVisible="@_showTerminal" OnClose="CloseTerminal" />
    <ToastContainer />
</div>

@code {
    private List<ActionConfig> _actions = new();
    private IReadOnlyList<IPlugin>? _visiblePlugins;
    private bool _showTimeReport;
    private bool _showTerminal;
    private TerminalOutput? _terminalOutput;

    protected override void OnInitialized()
    {
        SettingsService.OnActiveProjectChanged += OnProjectChanged;

        var project = SettingsService.GetActiveProject();
        if (project != null)
        {
            ApplyProject(project);
        }
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            ThemeService.OnThemeChanged += OnThemeChanged;
        }
    }

    private void OnThemeChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private void ApplyProject(ProjectConfig project)
    {
        _actions = project.Actions;
        ThemeService.SetTheme(project.Theme);

        var allPlugins = PluginLoader.GetPlugins();
        _visiblePlugins = allPlugins
            .Where(p => project.EnabledPlugins.Contains(p.UniqueId))
            .ToList()
            .AsReadOnly();

        var context = new PluginContext { Project = project };
        foreach (var plugin in allPlugins)
        {
            _ = plugin.OnProjectChangedAsync(context);
        }
    }

    private void OnProjectChanged(ProjectConfig project)
    {
        InvokeAsync(() =>
        {
            ApplyProject(project);
            StateHasChanged();
        });
    }

    private void ToggleTimeReport()
    {
        _showTimeReport = !_showTimeReport;
    }

    private void CloseTimeReport()
    {
        _showTimeReport = false;
    }

    private void CloseTerminal()
    {
        _showTerminal = false;
    }

    private async Task HandleActionClicked(ActionConfig action)
    {
        try
        {
            if (action.ActionType == ActionType.Script)
            {
                _showTerminal = true;
                StateHasChanged();
                await Task.Yield();
                if (_terminalOutput != null)
                {
                    await _terminalOutput.RunScript(ScriptService, action.Interpreter ?? "pwsh", action.ProcessPath, action.Arguments);
                }
                return;
            }

            if (!string.IsNullOrEmpty(action.WindowTitleRegex))
            {
                if (!ProcessService.FocusWindowByTitle(action.WindowTitleRegex))
                {
                    await ProcessService.StartProcessAsync(action.ProcessPath, action.Arguments);
                }
            }
            else
            {
                await ProcessService.StartProcessAsync(action.ProcessPath, action.Arguments);
            }
            NotificationService.ShowSuccess($"Launched {action.Label}", "Action");
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to launch {action.Label}: {ex.Message}", "Error");
        }
    }

    public void Dispose()
    {
        SettingsService.OnActiveProjectChanged -= OnProjectChanged;
        ThemeService.OnThemeChanged -= OnThemeChanged;
    }
}
