@using DevToolbar.Core.Interfaces
@using DevToolbar.Core.Models
@using DevToolbar.UI.Services
@using DevToolbar.UI.Components
@implements IDisposable
@inject IPluginLoader PluginLoader
@inject ISettingsService SettingsService
@inject IProcessService ProcessService
@inject ThemeService ThemeService

<div class="toolbar-shell" style="@ThemeService.GetCssVariables()">
    <header class="toolbar-header">
        <div class="toolbar-brand">
            <span class="brand-icon">ðŸ› </span>
            <span class="brand-title">DevToolbar</span>
        </div>
        <ProjectSelector />
    </header>

    <main class="toolbar-main">
        <section class="toolbar-plugins">
            <PluginZone Plugins="@_visiblePlugins" />
        </section>

        <section class="toolbar-actions">
            <ActionDeck Actions="@_actions" OnActionClicked="HandleActionClicked" />
        </section>
    </main>
</div>

@code {
    private List<ActionConfig> _actions = new();
    private IReadOnlyList<IPlugin>? _visiblePlugins;

    protected override void OnInitialized()
    {
        var project = SettingsService.GetActiveProject();
        if (project != null)
        {
            ApplyProject(project);
        }

        SettingsService.OnActiveProjectChanged += OnProjectChanged;
        ThemeService.OnThemeChanged += StateHasChanged;
    }

    private void ApplyProject(ProjectConfig project)
    {
        _actions = project.Actions;
        ThemeService.SetTheme(project.Theme);

        // Filter plugins by project's enabled list
        var allPlugins = PluginLoader.GetPlugins();
        _visiblePlugins = allPlugins
            .Where(p => project.EnabledPlugins.Contains(p.UniqueId))
            .ToList()
            .AsReadOnly();

        // Notify all plugins of project change
        var context = new PluginContext { Project = project };
        foreach (var plugin in allPlugins)
        {
            _ = plugin.OnProjectChangedAsync(context);
        }
    }

    private void OnProjectChanged(ProjectConfig project)
    {
        InvokeAsync(() =>
        {
            ApplyProject(project);
            StateHasChanged();
        });
    }

    private async Task HandleActionClicked(ActionConfig action)
    {
        try
        {
            if (!string.IsNullOrEmpty(action.WindowTitleRegex))
            {
                if (!ProcessService.FocusWindowByTitle(action.WindowTitleRegex))
                {
                    await ProcessService.StartProcessAsync(action.ProcessPath, action.Arguments);
                }
            }
            else
            {
                await ProcessService.StartProcessAsync(action.ProcessPath, action.Arguments);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error executing action '{action.Label}': {ex.Message}");
        }
    }

    public void Dispose()
    {
        SettingsService.OnActiveProjectChanged -= OnProjectChanged;
        ThemeService.OnThemeChanged -= StateHasChanged;
    }
}
