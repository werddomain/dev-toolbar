@page "/settings"
@using DevToolbar.Core.Interfaces
@using DevToolbar.Core.Models
@inject ISettingsService SettingsService
@inject IPluginLoader PluginLoader

<PageTitle>DevToolbar - Settings</PageTitle>

<div class="settings-page">
    <header class="settings-header">
        <h2>⚙️ Settings</h2>
        <a href="/" class="settings-back">← Back to Toolbar</a>
    </header>

    <div class="settings-content">
        @if (_activeProject != null)
        {
            <section class="settings-section">
                <h3>Active Project</h3>
                <div class="settings-field">
                    <label>Name</label>
                    <span class="settings-value">@_activeProject.Name</span>
                </div>
                <div class="settings-field">
                    <label>Type</label>
                    <span class="settings-value">@_activeProject.ProjectType</span>
                </div>
                <div class="settings-field">
                    <label>Path</label>
                    <span class="settings-value settings-path">@_activeProject.Path</span>
                </div>
            </section>

            <section class="settings-section">
                <h3>Theme</h3>
                <div class="settings-field">
                    <label>Accent Color</label>
                    <div class="settings-color-preview">
                        <span class="color-swatch" style="background-color: @_activeProject.Theme.AccentColor"></span>
                        <span class="settings-value">@_activeProject.Theme.AccentColor</span>
                    </div>
                </div>
                <div class="settings-field">
                    <label>Font Family</label>
                    <span class="settings-value">@_activeProject.Theme.FontFamily</span>
                </div>
            </section>

            <section class="settings-section">
                <h3>Enabled Plugins</h3>
                <div class="settings-plugins-list">
                    @foreach (var plugin in _allPlugins)
                    {
                        var pluginId = plugin.UniqueId;
                        var isEnabled = _activeProject.EnabledPlugins.Contains(pluginId);
                        <div class="settings-plugin-row">
                            <label class="settings-toggle">
                                <input type="checkbox" checked="@isEnabled"
                                       class="settings-plugin-checkbox"
                                       @onchange="@(e => TogglePlugin(pluginId, (bool)(e.Value ?? false)))" />
                                <span class="settings-toggle-slider"></span>
                            </label>
                            <span class="settings-plugin-name">@plugin.Name</span>
                            <span class="settings-plugin-id">@plugin.UniqueId</span>
                        </div>
                    }
                </div>
            </section>

            <section class="settings-section">
                <h3>Quick Actions (@_activeProject.Actions.Count)</h3>
                <div class="settings-actions-list">
                    @foreach (var action in _activeProject.Actions)
                    {
                        <div class="settings-action-row">
                            <span class="settings-action-icon">@action.Icon</span>
                            <span class="settings-action-label">@action.Label</span>
                            <span class="settings-action-path">@action.ProcessPath</span>
                        </div>
                    }
                </div>
            </section>
        }

        <section class="settings-section">
            <h3>All Projects</h3>
            <div class="settings-projects-list">
                @if (_projects != null)
                {
                    @foreach (var project in _projects)
                    {
                        var isActive = project.Id == _activeProject?.Id;
                        <div class="settings-project-row @(isActive ? "active" : "")"
                             @onclick="@(() => SwitchProject(project.Id))"
                             style="cursor: pointer;">
                            <span class="settings-project-indicator" style="background-color: @project.Theme.AccentColor"></span>
                            <span class="settings-project-name">@project.Name</span>
                            <span class="settings-project-type">@project.ProjectType</span>
                            @if (isActive)
                            {
                                <span class="settings-project-badge">Active</span>
                            }
                        </div>
                    }
                }
            </div>
        </section>
    </div>
</div>

@code {
    private ProjectConfig? _activeProject;
    private IReadOnlyList<ProjectConfig>? _projects;
    private IReadOnlyList<IPlugin> _allPlugins = Array.Empty<IPlugin>();

    protected override async Task OnInitializedAsync()
    {
        _activeProject = SettingsService.GetActiveProject();
        _projects = await SettingsService.GetProjectsAsync();
        _allPlugins = PluginLoader.GetPlugins();
    }

    private void TogglePlugin(string pluginId, bool enabled)
    {
        if (_activeProject == null) return;

        if (enabled && !_activeProject.EnabledPlugins.Contains(pluginId))
        {
            _activeProject.EnabledPlugins.Add(pluginId);
        }
        else if (!enabled)
        {
            _activeProject.EnabledPlugins.Remove(pluginId);
        }
    }

    private async Task SwitchProject(string projectId)
    {
        if (_activeProject?.Id == projectId) return;

        await SettingsService.SetActiveProjectAsync(projectId);
        _activeProject = SettingsService.GetActiveProject();
    }
}
