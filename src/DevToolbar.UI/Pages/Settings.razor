@page "/settings"
@using DevToolbar.Core.Interfaces
@using DevToolbar.Core.Models
@using DevToolbar.UI.Services
@inject ISettingsService SettingsService
@inject IPluginLoader PluginLoader
@inject IGlobalSettingsService GlobalSettingsService
@inject IWindowService WindowService

<PageTitle>DevToolbar - Settings</PageTitle>

<div class="settings-page">
    <header class="settings-header">
        <h2>‚öôÔ∏è Settings</h2>
        <a href="/" class="settings-back">‚Üê Back to Toolbar</a>
    </header>

    <div class="settings-content">
        @if (_activeProject != null)
        {
            <section class="settings-section">
                <h3>Active Project</h3>
                <div class="settings-field">
                    <label>Name</label>
                    <span class="settings-value">@_activeProject.Name</span>
                </div>
                <div class="settings-field">
                    <label>Type</label>
                    <span class="settings-value">@_activeProject.ProjectType</span>
                </div>
                <div class="settings-field">
                    <label>Path</label>
                    <span class="settings-value settings-path">@_activeProject.Path</span>
                </div>
                <div class="settings-field">
                    <label>Default Branch</label>
                    <span class="settings-value">@_activeProject.DefaultBranch</span>
                </div>
                @if (!string.IsNullOrEmpty(_activeProject.RepositoryUrl))
                {
                    <div class="settings-field">
                        <label>Repository</label>
                        <a href="@_activeProject.RepositoryUrl" target="_blank" class="settings-value settings-link">@_activeProject.RepositoryUrl</a>
                    </div>
                }
            </section>

            <section class="settings-section">
                <h3>Theme</h3>
                <div class="settings-field">
                    <label>Accent Color</label>
                    <div class="settings-color-preview">
                        <input type="color" value="@_activeProject.Theme.AccentColor"
                               class="settings-color-picker"
                               @onchange="@(e => UpdateAccentColor(e.Value?.ToString() ?? "#0d6efd"))" />
                        <span class="settings-value">@_activeProject.Theme.AccentColor</span>
                    </div>
                </div>
                <div class="settings-field">
                    <label>Font Family</label>
                    <select class="settings-font-select" value="@_activeProject.Theme.FontFamily"
                            @onchange="@(e => UpdateFontFamily(e.Value?.ToString() ?? "Segoe UI"))">
                        <option value="Segoe UI">Segoe UI</option>
                        <option value="Cascadia Code">Cascadia Code</option>
                        <option value="Consolas">Consolas</option>
                        <option value="JetBrains Mono">JetBrains Mono</option>
                        <option value="Fira Code">Fira Code</option>
                        <option value="Inter">Inter</option>
                    </select>
                </div>
            </section>

            @* ‚îÄ‚îÄ Toolbar Behavior Settings ‚îÄ‚îÄ *@
            <section class="settings-section settings-toolbar-section">
                <h3>üñ•Ô∏è Toolbar Behavior</h3>

                <div class="settings-field">
                    <label>Mode</label>
                    <div class="settings-radio-group">
                        @foreach (var behavior in Enum.GetValues<ToolbarBehavior>())
                        {
                            <label class="settings-radio-item">
                                <input type="radio" name="toolbarBehavior"
                                       value="@behavior"
                                       checked="@(_globalSettings.ToolbarBehavior == behavior)"
                                       @onchange="@(() => UpdateToolbarBehavior(behavior))" />
                                <span class="radio-label">@GetBehaviorLabel(behavior)</span>
                                <span class="radio-desc">@GetBehaviorDescription(behavior)</span>
                            </label>
                        }
                    </div>
                </div>

                <div class="settings-field">
                    <label>Target Monitor</label>
                    <select class="settings-monitor-select"
                            value="@_globalSettings.TargetMonitorIndex"
                            @onchange="@(e => UpdateTargetMonitor(int.TryParse(e.Value?.ToString(), out var v) ? v : 0))">
                        @foreach (var monitor in _monitors)
                        {
                            <option value="@monitor.Index">@monitor.DisplayLabel (@(monitor.Bounds.Width)√ó@(monitor.Bounds.Height))</option>
                        }
                    </select>
                </div>

                <div class="settings-field">
                    <label>Toolbar Height (px)</label>
                    <input type="number" min="32" max="120"
                           value="@_globalSettings.ToolbarHeight"
                           class="settings-monitor-select"
                           @onchange="@(e => UpdateToolbarHeight(int.TryParse(e.Value?.ToString(), out var v) ? v : 56))" />
                </div>

                <div class="settings-plugin-row">
                    <label class="settings-toggle">
                        <input type="checkbox"
                               checked="@_globalSettings.TaskbarReplacementMode"
                               class="settings-plugin-checkbox"
                               @onchange="@(e => UpdateTaskbarReplacement((bool)(e.Value ?? false)))" />
                        <span class="settings-toggle-slider"></span>
                    </label>
                    <span class="settings-plugin-name">Taskbar Replacement Mode</span>
                </div>

                <div class="settings-plugin-row">
                    <label class="settings-toggle">
                        <input type="checkbox"
                               checked="@_globalSettings.ShowActiveWindows"
                               class="settings-plugin-checkbox"
                               @onchange="@(e => UpdateShowActiveWindows((bool)(e.Value ?? false)))" />
                        <span class="settings-toggle-slider"></span>
                    </label>
                    <span class="settings-plugin-name">Show Active Windows</span>
                </div>
            </section>

            <section class="settings-section">
                <h3>Enabled Plugins</h3>
                <div class="settings-plugins-list">
                    @foreach (var plugin in _allPlugins)
                    {
                        var pluginId = plugin.UniqueId;
                        var isEnabled = _activeProject.EnabledPlugins.Contains(pluginId);
                        <div class="settings-plugin-row">
                            <label class="settings-toggle">
                                <input type="checkbox" checked="@isEnabled"
                                       class="settings-plugin-checkbox"
                                       @onchange="@(e => TogglePlugin(pluginId, (bool)(e.Value ?? false)))" />
                                <span class="settings-toggle-slider"></span>
                            </label>
                            <span class="settings-plugin-name">@plugin.Name</span>
                            <span class="settings-plugin-id">@plugin.UniqueId</span>
                        </div>
                    }
                </div>
            </section>

            <section class="settings-section">
                <h3>Quick Actions (@_activeProject.Actions.Count)</h3>
                <div class="settings-actions-list">
                    @foreach (var action in _activeProject.Actions)
                    {
                        <div class="settings-action-row">
                            <span class="settings-action-icon">@action.Icon</span>
                            <span class="settings-action-label">@action.Label</span>
                            <span class="settings-action-path">@action.ProcessPath</span>
                        </div>
                    }
                </div>
            </section>
        }

        <section class="settings-section">
            <h3>All Projects</h3>
            <div class="settings-projects-list">
                @if (_projects != null)
                {
                    @foreach (var project in _projects)
                    {
                        var isActive = project.Id == _activeProject?.Id;
                        <div class="settings-project-row @(isActive ? "active" : "")"
                             @onclick="@(() => SwitchProject(project.Id))"
                             style="cursor: pointer;">
                            <span class="settings-project-indicator" style="background-color: @project.Theme.AccentColor"></span>
                            <span class="settings-project-name">@project.Name</span>
                            <span class="settings-project-type">@project.ProjectType</span>
                            @if (isActive)
                            {
                                <span class="settings-project-badge">Active</span>
                            }
                        </div>
                    }
                }
            </div>
        </section>

        <section class="settings-section">
            <h3>Configuration Hierarchy</h3>
            <p class="settings-description">Settings are resolved in order of priority (highest first):</p>
            <div class="settings-config-hierarchy">
                <div class="config-level">
                    <span class="config-level-badge config-level-1">1</span>
                    <span class="config-level-name">.devtoolbar.json</span>
                    <span class="config-level-desc">Local project override (in project directory)</span>
                    @if (_activeProject != null)
                    {
                        <span class="config-level-path">@(_activeProject.Path)/.devtoolbar.json</span>
                    }
                </div>
                <div class="config-level">
                    <span class="config-level-badge config-level-2">2</span>
                    <span class="config-level-name">Template Config</span>
                    <span class="config-level-desc">Project type template (e.g., WebApi, SPA)</span>
                    @if (_activeProject != null)
                    {
                        <span class="config-level-path">template-@(_activeProject.ProjectType?.ToLowerInvariant() ?? "unknown").json</span>
                    }
                </div>
                <div class="config-level">
                    <span class="config-level-badge config-level-3">3</span>
                    <span class="config-level-name">Global Config</span>
                    <span class="config-level-desc">User-wide default settings</span>
                    <span class="config-level-path">%APPDATA%/DevToolbar/global.json</span>
                </div>
            </div>
        </section>
    </div>
</div>

@code {
    private ProjectConfig? _activeProject;
    private IReadOnlyList<ProjectConfig>? _projects;
    private IReadOnlyList<IPlugin> _allPlugins = Array.Empty<IPlugin>();
    private GlobalSettings _globalSettings = new();
    private List<MonitorInfo> _monitors = new();

    [Inject]
    private ThemeService ThemeService { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        _activeProject = SettingsService.GetActiveProject();
        _projects = await SettingsService.GetProjectsAsync();
        _allPlugins = PluginLoader.GetPlugins();

        // Load global settings and monitor list
        _globalSettings = GlobalSettingsService.Current;
        _monitors = WindowService.GetMonitors();
    }

    private void TogglePlugin(string pluginId, bool enabled)
    {
        if (_activeProject == null) return;

        if (enabled && !_activeProject.EnabledPlugins.Contains(pluginId))
        {
            _activeProject.EnabledPlugins.Add(pluginId);
        }
        else if (!enabled)
        {
            _activeProject.EnabledPlugins.Remove(pluginId);
        }
        // Note: Changes are applied in-memory. In MAUI, JsonSettingsService persists to disk.
    }

    private void UpdateAccentColor(string color)
    {
        if (_activeProject == null) return;
        _activeProject.Theme.AccentColor = color;
        ThemeService.SetTheme(_activeProject.Theme);
    }

    private void UpdateFontFamily(string fontFamily)
    {
        if (_activeProject == null) return;
        _activeProject.Theme.FontFamily = fontFamily;
        ThemeService.SetTheme(_activeProject.Theme);
    }

    private async Task SwitchProject(string projectId)
    {
        if (_activeProject?.Id == projectId) return;

        await SettingsService.SetActiveProjectAsync(projectId);
        _activeProject = SettingsService.GetActiveProject();
    }

    // --- Toolbar Behavior settings ---

    private async Task UpdateToolbarBehavior(ToolbarBehavior behavior)
    {
        await GlobalSettingsService.UpdateAsync(s => s.ToolbarBehavior = behavior);
        _globalSettings = GlobalSettingsService.Current;
    }

    private async Task UpdateTargetMonitor(int monitorIndex)
    {
        await GlobalSettingsService.UpdateAsync(s => s.TargetMonitorIndex = monitorIndex);
        _globalSettings = GlobalSettingsService.Current;
    }

    private async Task UpdateToolbarHeight(int height)
    {
        height = Math.Clamp(height, 32, 120);
        await GlobalSettingsService.UpdateAsync(s => s.ToolbarHeight = height);
        _globalSettings = GlobalSettingsService.Current;
    }

    private async Task UpdateTaskbarReplacement(bool enabled)
    {
        await GlobalSettingsService.UpdateAsync(s => s.TaskbarReplacementMode = enabled);
        _globalSettings = GlobalSettingsService.Current;
    }

    private async Task UpdateShowActiveWindows(bool enabled)
    {
        await GlobalSettingsService.UpdateAsync(s => s.ShowActiveWindows = enabled);
        _globalSettings = GlobalSettingsService.Current;
    }

    private static string GetBehaviorLabel(ToolbarBehavior behavior) => behavior switch
    {
        ToolbarBehavior.DockedTop => "Docked Top",
        ToolbarBehavior.DockedBottom => "Docked Bottom",
        ToolbarBehavior.Floating => "Floating",
        ToolbarBehavior.Overlay => "Overlay",
        _ => behavior.ToString()
    };

    private static string GetBehaviorDescription(ToolbarBehavior behavior) => behavior switch
    {
        ToolbarBehavior.DockedTop => "Anchored at top, reserves screen space",
        ToolbarBehavior.DockedBottom => "Anchored at bottom, reserves screen space",
        ToolbarBehavior.Floating => "Free-floating window, movable",
        ToolbarBehavior.Overlay => "Always on top, no space reserved",
        _ => string.Empty
    };
}
