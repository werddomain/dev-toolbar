@using DevToolbar.Core.Interfaces
@using DevToolbar.Core.Models
@using Microsoft.JSInterop
@inject ITimeTrackingService TimeTrackingService
@inject ISettingsService SettingsService
@inject IJSRuntime JSRuntime

<div class="time-report-overlay @(_isVisible ? "visible" : "")" @onclick="Close">
    <div class="time-report-modal" @onclick:stopPropagation="true">
        <header class="time-report-header">
            <h3>üìä Time Report</h3>
            <button class="time-report-close" @onclick="Close">‚úï</button>
        </header>

        <div class="time-report-filters">
            <select class="time-report-filter" @onchange="OnPeriodChanged">
                <option value="day" selected="@(_period == "day")">Today</option>
                <option value="week" selected="@(_period == "week")">This Week</option>
                <option value="month" selected="@(_period == "month")">This Month</option>
            </select>
            <select class="time-report-filter" @onchange="OnGroupByChanged">
                <option value="none" selected="@(_groupBy == "none")">No Grouping</option>
                <option value="project" selected="@(_groupBy == "project")">By Project</option>
                <option value="workitem" selected="@(_groupBy == "workitem")">By Work Item</option>
                <option value="day" selected="@(_groupBy == "day")">By Day</option>
            </select>
            <button class="time-report-export" @onclick="ExportCsv" title="Export to CSV">üì• Export CSV</button>
        </div>

        <div class="time-report-body">
            @if (_entries != null && _entries.Count > 0)
            {
                <div class="time-report-summary">
                    <span class="time-report-total-label">Total:</span>
                    <span class="time-report-total-value">@FormatDuration(_totalDuration)</span>
                </div>

                @if (_groupBy == "project")
                {
                    var grouped = _crossProjectEntries!
                        .Where(e => e.StartTime >= GetCutoff())
                        .GroupBy(e => e.ProjectId)
                        .Select(g => new { Key = g.Key, Total = g.Aggregate(TimeSpan.Zero, (sum, e) => sum + e.Duration), Entries = g.ToList() })
                        .OrderByDescending(g => g.Total);

                    <div class="time-report-grouped">
                        @foreach (var group in grouped)
                        {
                            var projectName = _projectNames.GetValueOrDefault(group.Key, group.Key);
                            <div class="time-report-group">
                                <div class="time-report-group-header">
                                    <span class="time-report-group-key">üìÅ @projectName</span>
                                    <span class="time-report-group-total">@FormatDuration(group.Total)</span>
                                </div>
                                @foreach (var entry in group.Entries)
                                {
                                    <div class="time-report-group-entry">
                                        <span>@entry.StartTime.ToString("HH:mm") ‚Äî @(entry.WorkItemId != null ? $"#{entry.WorkItemId}" : "‚Äî")</span>
                                        <span class="time-report-duration">@FormatDuration(entry.Duration)</span>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
                else if (_groupBy == "workitem")
                {
                    var grouped = _entries.GroupBy(e => e.WorkItemId ?? "(no work item)")
                        .Select(g => new { Key = g.Key, Total = g.Aggregate(TimeSpan.Zero, (sum, e) => sum + e.Duration), Entries = g.ToList() })
                        .OrderByDescending(g => g.Total);

                    <div class="time-report-grouped">
                        @foreach (var group in grouped)
                        {
                            <div class="time-report-group">
                                <div class="time-report-group-header">
                                    <span class="time-report-group-key">üìã @(group.Key == "(no work item)" ? "No Work Item" : $"#{group.Key}")</span>
                                    <span class="time-report-group-total">@FormatDuration(group.Total)</span>
                                </div>
                                @foreach (var entry in group.Entries)
                                {
                                    <div class="time-report-group-entry">
                                        <span>@entry.StartTime.ToString("HH:mm")</span>
                                        <span class="time-report-duration">@FormatDuration(entry.Duration)</span>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
                else if (_groupBy == "day")
                {
                    var grouped = _entries.GroupBy(e => e.StartTime.Date)
                        .Select(g => new { Key = g.Key, Total = g.Aggregate(TimeSpan.Zero, (sum, e) => sum + e.Duration), Entries = g.ToList() })
                        .OrderByDescending(g => g.Key);

                    <div class="time-report-grouped">
                        @foreach (var group in grouped)
                        {
                            <div class="time-report-group">
                                <div class="time-report-group-header">
                                    <span class="time-report-group-key">üìÖ @group.Key.ToString("ddd, MMM dd")</span>
                                    <span class="time-report-group-total">@FormatDuration(group.Total)</span>
                                </div>
                                @foreach (var entry in group.Entries)
                                {
                                    <div class="time-report-group-entry">
                                        <span>@entry.StartTime.ToString("HH:mm") ‚Äî @(entry.WorkItemId != null ? $"#{entry.WorkItemId}" : "‚Äî")</span>
                                        <span class="time-report-duration">@FormatDuration(entry.Duration)</span>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
                else
                {
                    <table class="time-report-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Duration</th>
                                <th>Work Item</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var entry in _entries)
                            {
                                <tr class="time-report-row">
                                    <td>@entry.StartTime.ToString("yyyy-MM-dd HH:mm")</td>
                                    <td class="time-report-duration">@FormatDuration(entry.Duration)</td>
                                    <td>@(entry.WorkItemId != null ? $"#{entry.WorkItemId}" : "‚Äî")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            }
            else
            {
                <div class="time-report-empty">No entries for this period.</div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter]
    public bool IsVisible { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    private bool _isVisible;
    private string _period = "day";
    private string _groupBy = "none";
    private IReadOnlyList<TimeEntry>? _entries;
    private List<TimeEntry>? _crossProjectEntries;
    private Dictionary<string, string> _projectNames = new();
    private TimeSpan _totalDuration;

    protected override async Task OnParametersSetAsync()
    {
        _isVisible = IsVisible;
        if (_isVisible)
        {
            await LoadEntries();
        }
    }

    private async Task LoadEntries()
    {
        var project = SettingsService.GetActiveProject();
        if (project == null) return;

        var allEntries = await TimeTrackingService.GetEntriesAsync(project.Id);
        var cutoff = GetCutoff();

        _entries = allEntries.Where(e => e.StartTime >= cutoff).OrderByDescending(e => e.StartTime).ToList();
        _totalDuration = _entries.Aggregate(TimeSpan.Zero, (sum, e) => sum + e.Duration);

        // Load all projects' entries for "by project" grouping (US5.4)
        var projects = await SettingsService.GetProjectsAsync();
        _projectNames = projects.ToDictionary(p => p.Id, p => p.Name);
        var allProjectEntries = new List<TimeEntry>();
        foreach (var p in projects)
        {
            var entries = await TimeTrackingService.GetEntriesAsync(p.Id);
            allProjectEntries.AddRange(entries);
        }
        _crossProjectEntries = allProjectEntries;
    }

    private DateTime GetCutoff() => _period switch
    {
        "week" => DateTime.Now.AddDays(-7),
        "month" => DateTime.Now.AddDays(-30),
        _ => DateTime.Today
    };

    private async Task OnPeriodChanged(ChangeEventArgs e)
    {
        _period = e.Value?.ToString() ?? "day";
        await LoadEntries();
    }

    private void OnGroupByChanged(ChangeEventArgs e)
    {
        _groupBy = e.Value?.ToString() ?? "none";
        // Grouping is a view-only operation - no need to reload data
    }

    private async Task Close()
    {
        _isVisible = false;
        await OnClose.InvokeAsync();
    }

    private async Task ExportCsv()
    {
        if (_entries == null || _entries.Count == 0) return;

        var csv = new System.Text.StringBuilder();
        csv.AppendLine("Date,Start Time,Duration,Work Item");
        foreach (var entry in _entries)
        {
            var duration = FormatDuration(entry.Duration);
            var workItem = EscapeCsvField(entry.WorkItemId ?? "");
            csv.AppendLine($"{entry.StartTime:yyyy-MM-dd},{entry.StartTime:HH:mm},{duration},{workItem}");
        }

        var safePeriod = _period.Replace(" ", "-").Replace("/", "-");
        var filename = $"time-report-{safePeriod}-{DateTime.Now:yyyyMMdd}.csv";
        await JSRuntime.InvokeVoidAsync("DevToolbar.downloadCsv", filename, csv.ToString());
    }

    private static string EscapeCsvField(string field)
    {
        if (field.Contains(',') || field.Contains('"') || field.Contains('\n'))
        {
            return $"\"{field.Replace("\"", "\"\"")}\"";
        }
        return field;
    }

    private static string FormatDuration(TimeSpan duration) =>
        $"{(int)duration.TotalHours:D2}:{duration.Minutes:D2}:{duration.Seconds:D2}";
}
