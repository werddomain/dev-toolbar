<?xml version="1.0" encoding="utf-8" ?>
<ContentPage 
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:controls="clr-namespace:DevToolbar.Maui.Controls"
    xmlns:vm="clr-namespace:DevToolbar.Maui.ViewModels"
    x:Class="DevToolbar.Maui.Views.NativeToolbarPage"
    x:Name="thisPage"
    x:DataType="vm:ToolbarViewModel"
    BackgroundColor="Transparent"
    Shell.NavBarIsVisible="False"
    NavigationPage.HasNavigationBar="False">

    <!--
        NativeToolbarPage: Main toolbar assembled from XAML UserControls.
        Uses MVVM data binding (ToolbarViewModel).
        On Windows, the native window is configured borderless + always-on-top + SetWindowRgn pill clip.
    -->

    <Grid>
        <!-- ═══ Main Toolbar Shell ═══ -->
        <Border 
            x:Name="ToolbarShell"
            VerticalOptions="Start"
            HorizontalOptions="Fill"
            HeightRequest="68"
            Padding="6"
            StrokeShape="RoundRectangle 34"
            Background="{DynamicResource ShellBackground}"
            Stroke="{DynamicResource ShellBorder}"
            StrokeThickness="1">

            <!-- Double-tap to cycle theme -->
            <Border.GestureRecognizers>
                <TapGestureRecognizer NumberOfTapsRequired="2" Command="{Binding CycleThemeCommand}" />
            </Border.GestureRecognizers>

            <Grid ColumnDefinitions="Auto,Auto,*,Auto" VerticalOptions="Center">
                <!-- Zone 1: Project Pill (highest z-index) -->
                <controls:ProjectPillView 
                    Grid.Column="0" 
                    ZIndex="20" />

                <!-- Zone 2: Git Branch Pill (overlaps under project pill) -->
                <controls:GitBranchPillView 
                    Grid.Column="1" 
                    ZIndex="10" />

                <!-- Zone 3: Action Buttons (centered) -->
                <controls:ActionBarView 
                    Grid.Column="2" 
                    ZIndex="1" />

                <!-- Zone 4: System Pill (right side) -->
                <controls:SystemPillView 
                    Grid.Column="3" 
                    ZIndex="20" />
            </Grid>
        </Border>

        <!-- ═══ Project Dropdown Overlay ═══ -->
        <Border 
            x:Name="DropdownOverlay"
            IsVisible="{Binding IsDropdownOpen}"
            VerticalOptions="Start"
            HorizontalOptions="Start"
            Margin="6,72,0,0"
            StrokeShape="RoundRectangle 12"
            Background="{DynamicResource DropdownBackground}"
            Stroke="{DynamicResource DropdownBorder}"
            StrokeThickness="1"
            MinimumWidthRequest="220"
            Padding="4">

            <CollectionView 
                ItemsSource="{Binding Projects}"
                SelectionMode="Single"
                SelectionChanged="OnProjectSelected">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="vm:ProjectItem">
                        <HorizontalStackLayout 
                            Spacing="10" 
                            Padding="12,10">
                            <!-- Project icon -->
                            <Label 
                                Text="&#xE895;" 
                                FontFamily="Segoe MDL2 Assets" 
                                FontSize="16"
                                TextColor="{DynamicResource DropdownTextColor}" 
                                VerticalOptions="Center" />
                            <!-- Project name -->
                            <Label 
                                Text="{Binding Name}" 
                                FontSize="14"
                                TextColor="{DynamicResource DropdownTextColor}" 
                                VerticalOptions="Center" />
                        </HorizontalStackLayout>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </Border>
    </Grid>

</ContentPage>
